#!/bin/bash
# Don't exit on error so we can see what's happening
set +e

echo "Starting pre-commit hook..."

# Store the Swift files that have been changed
SWIFT_FILES=$(git diff --cached --name-only --diff-filter=d | grep -e '\.swift$' || echo "")

# Store the TypeScript files that have been changed
TS_FILES=$(git diff --cached --name-only --diff-filter=d | grep -E '\.ts$|\.tsx$' || echo "")

# Process Swift files
if [[ "$SWIFT_FILES" != "" ]]; then
  echo "Swift files to format:"
  echo "$SWIFT_FILES" | sed 's/^/  - /'
  echo "Running pre-commit hook for Swift files..."

  if ! command -v swiftformat &> /dev/null; then
    echo "swiftformat not found. Please install it before committing."
    exit 1
  fi

  # Run SwiftFormat with verbose output
  swiftformat $SWIFT_FILES
  SWIFTFORMAT_EXIT_CODE=$?
  if [ $SWIFTFORMAT_EXIT_CODE -ne 0 ]; then
    echo "swiftformat encountered an error with exit code: $SWIFTFORMAT_EXIT_CODE"
    exit 1
  fi

  # Add back the formatted files to staging
  git add $SWIFT_FILES

  echo "Swift formatting complete!"
else
  echo "No Swift files to format."
fi

# Process TypeScript files
if [[ "$TS_FILES" != "" ]]; then
  echo "TypeScript files to format:"
  echo "$TS_FILES" | sed 's/^/  - /'
  echo "Running pre-commit hook for TypeScript files..."

  if ! command -v prettier &> /dev/null; then
    echo "prettier not found. Please run ./scripts/setup-ts-tools.sh to install it."
    exit 1
  fi

  echo "Checking TypeScript files with Prettier..."
  NEEDS_FORMATTING=""
  for file in $TS_FILES; do
    if ! prettier --check "$file" &>/dev/null; then
      NEEDS_FORMATTING="$NEEDS_FORMATTING $file"
      echo "   WARNING: $file (needs formatting)"
    else
      echo "   OK: $file (already formatted)"
    fi
  done

  # Format files that need it
  if [ -n "$NEEDS_FORMATTING" ]; then
    echo "Formatting files with Prettier..."
    prettier --write $NEEDS_FORMATTING
    PRETTIER_EXIT_CODE=$?
    if [ $PRETTIER_EXIT_CODE -ne 0 ]; then
      echo "prettier encountered an error while formatting with exit code: $PRETTIER_EXIT_CODE"
      exit 1
    fi
    git add $NEEDS_FORMATTING
    echo "   Formatting complete"
  else
    echo "   All files already properly formatted"
  fi

  echo "TypeScript processing complete!"
else
  echo "No TypeScript files to format."
fi

echo "Pre-commit hook completed successfully!"
exit 0
