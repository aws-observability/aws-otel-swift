name: Soak Test

on:
  workflow_dispatch:
  push:
    branches: [ main, test/e2e ]

jobs:
  run-soak-test:
    runs-on: macos-15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 16.4

    
    - name: Setup iOS Signing
      run: |
        echo "${{ secrets.IOS_CERTIFICATE }}" | base64 --decode > certificate.p12
        echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > profile.mobileprovision
        
        security create-keychain -p "" build.keychain
        security import certificate.p12 -k build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -A
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
        
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
    
    - name: Build iOS App
      run: |
        xcodebuild -project Examples/PetClinic/PetClinic.xcodeproj \
          -scheme PetClinic \
          -destination 'generic/platform=iOS' \
          -derivedDataPath Examples/PetClinic/build \
          -archivePath Examples/PetClinic/PetClinic.xcarchive \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM_ID }}" \
          PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_SPECIFIER }}" \
          clean archive
    
    - name: Update ExportOptions with Team ID
      run: |
        sed -i '' 's/YOUR_TEAM_ID/${{ secrets.DEVELOPMENT_TEAM_ID }}/g' Examples/PetClinic/ExportOptions.plist

    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath Examples/PetClinic/PetClinic.xcarchive \
          -exportPath Examples/PetClinic \
          -exportOptionsPlist Examples/PetClinic/ExportOptions.plist
        
    - name: Build for Testing to Generate XCTestRun File
      run: |
        xcodebuild -project Examples/PetClinic/PetClinic.xcodeproj \
          -scheme PetClinic \
          -destination 'platform=iOS' \
          -derivedDataPath Examples/PetClinic/build \
          DEVELOPMENT_TEAM="${{ secrets.DEVELOPMENT_TEAM_ID }}" \
          build-for-testing 
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_RUM_GAMMA_OIDC_ROLE }}
        aws-region: ${{ secrets.AWS_RUM_GAMMA_REGION }}
        bucket_name: ${{ secrets.AWS_RUM_GAMMA_BUCKET_NAME }}
    
    - name: Upload TestSpec to S3
      run: |
        # Upload test specification
        set -o pipefail && aws s3 cp ${{ github.workspace }}/Examples/PetClinic/deviceFarmTestSpec.yaml s3://${{ secrets.AWS_RUM_GAMMA_BUCKET_NAME }}/testSpec/testSpec_$(date +%Y%m%d_%H%M%S).yaml --region ${{ secrets.AWS_RUM_GAMMA_REGION }} --metadata "commitHash=${{ github.sha }}"

    - name: Upload TestPackage to S3
      run: |
        # Upload test package
        export XCTESTRUN_FILE=$(find ${{ github.workspace }}/Examples/PetClinic/build/Build/Products/ -name "PetClinic_PetClinic_iphoneos*-arm64.xctestrun" | head -1)
        export TEST_PACKAGE=${{ github.workspace }}/Examples/PetClinic/build/Build/Products/Debug-iphoneos/PetClinicUITests-Runner.app
        export TEST_PACKAGE_ZIP=${{ github.workspace }}/Examples/PetClinic/build/Build/Products/Debug-iphoneos/PetClinicUITests-Runner.app.zip
        zip -r $TEST_PACKAGE_ZIP $TEST_PACKAGE
        zip -r $TEST_PACKAGE_ZIP $XCTESTRUN_FILE
        set -o pipefail && aws s3 cp $TEST_PACKAGE_ZIP s3://${{ secrets.AWS_RUM_GAMMA_BUCKET_NAME }}/tests/tests_$(date +%Y%m%d_%H%M%S).app.zip --region ${{ secrets.AWS_RUM_GAMMA_REGION }} --metadata "commitHash=${{ github.sha }}"

    - name: Upload App to S3
      run: |
        # Upload app
        set -o pipefail && aws s3 cp ${{ github.workspace }}/Examples/PetClinic/PetClinic.ipa s3://${{ secrets.AWS_RUM_GAMMA_BUCKET_NAME }}/app/PetClinic_$(date +%Y%m%d_%H%M%S).ipa --region ${{ secrets.AWS_RUM_GAMMA_REGION }} --metadata "commitHash=${{ github.sha }}"
        
    - name: Build Artifacts - App
      uses: actions/upload-artifact@v4
      with:
        name: petclinic-ios-app-archive
        path: ${{ github.workspace }}/Examples/PetClinic/PetClinic.ipa
        retention-days: 7

    - name: Build Artifacts - TestPackage Zip
      uses: actions/upload-artifact@v4
      with:
        name: petclinic-ios-test-package-zip
        path: $TEST_PACKAGE_ZIP
        retention-days: 7
    
