name: Soak Test

on:
  workflow_dispatch:
  push:
    branches: [ main, test/e2e ]

jobs:
  run-soak-test:
    runs-on: macos-15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 16.4

    
    - name: Setup iOS Signing
      run: |
        echo "${{ secrets.IOS_CERTIFICATE }}" | base64 --decode > certificate.p12
        echo "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > profile.mobileprovision
        
        # Create and configure keychain
        security create-keychain -p "" build.keychain
        security list-keychains -d user -s build.keychain login.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings build.keychain
        
        # Import certificate
        security import certificate.p12 -k build.keychain -P "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" -A
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
        
        # Install provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
    
    - name: Build iOS App
      run: |
        xcodebuild -project Examples/PetClinic/PetClinic.xcodeproj \
          -scheme PetClinic \
          -destination 'generic/platform=iOS' \
          -derivedDataPath Examples/PetClinic/build \
          -archivePath Examples/PetClinic/PetClinic.xcarchive \
          -allowProvisioningUpdates \
          archive
    
    - name: Update ExportOptions with Team ID and Provisioning Profile
      run: |
        sed -i '' 's/YOUR_TEAM_ID/${{ secrets.DEVELOPMENT_TEAM_ID }}/g' Examples/PetClinic/ExportOptions.plist
        sed -i '' 's/YOUR_PROVISIONING_PROFILE_NAME/aws-github-bot-profile-DO-NOT-DELETE/g' Examples/PetClinic/ExportOptions.plist

    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath Examples/PetClinic/PetClinic.xcarchive \
          -exportPath Examples/PetClinic \
          -exportOptionsPlist Examples/PetClinic/ExportOptions.plist
        
    - name: Build for Testing to Generate XCTestRun File
      run: |
        xcodebuild -project Examples/PetClinic/PetClinic.xcodeproj \
          -scheme PetClinic \
          -destination 'generic/platform=iOS' \
          -derivedDataPath Examples/PetClinic/build \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          build-for-testing 

    - name: Create test package zip
      run: | 
        export XCTESTRUN_FILE=$(find ${{ github.workspace }}/Examples/PetClinic/build/Build/Products/ -name "PetClinic_PetClinic_iphoneos*-arm64.xctestrun" | head -1)
        export TEST_PACKAGE=${{ github.workspace }}/Examples/PetClinic/build/Build/Products/Debug-iphoneos/PetClinicUITests-Runner.app
        export TEST_PACKAGE_ZIP=${{ github.workspace }}/Examples/PetClinic/build/Build/Products/Debug-iphoneos/PetClinicUITests-Runner.app.zip
        zip -r $TEST_PACKAGE_ZIP $TEST_PACKAGE
        zip -r $TEST_PACKAGE_ZIP $XCTESTRUN_FILE

    - name: Build Artifacts - App
      uses: actions/upload-artifact@v4
      with:
        name: petclinic-ios-app-archive
        path: ${{ github.workspace }}/Examples/PetClinic/PetClinic.ipa
        retention-days: 7

    - name: Build Artifacts - TestPackage Zip
      uses: actions/upload-artifact@v4
      with:
        name: petclinic-ios-test-package-zip
        path: ${{ env.TEST_PACKAGE_ZIP }}
        retention-days: 7
    
    - name: Build Artifacts - TestSpec
      uses: actions/upload-artifact@v4
      with:
        name: petclinic-ios-test-spec
        path: ${{ github.workspace }}/Examples/PetClinic/deviceFarmTestSpec.yaml
        retention-days: 7

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_RUM_GAMMA_OIDC_ROLE }}
        aws-region: ${{ secrets.AWS_RUM_GAMMA_REGION }}
        role-session-name: GitHubActions-SoakTest
        audience: sts.amazonaws.com

    - name: Upload TestSpec to S3
      run: |
        # Upload test specification
        set -o pipefail && aws s3 cp ${{ github.workspace }}/Examples/PetClinic/deviceFarmTestSpec.yaml s3://${{ secrets.AWS_RUM_GAMMA_BUCKET_NAME }}/testSpec/testSpec_$(date +%Y%m%d_%H%M%S).yaml --region ${{ secrets.AWS_RUM_GAMMA_REGION }} --metadata "commitHash=${{ github.sha }}"

    - name: Upload TestPackage to S3
      run: |
        # Upload test package
        set -o pipefail && aws s3 cp $TEST_PACKAGE_ZIP s3://${{ secrets.AWS_RUM_GAMMA_BUCKET_NAME }}/tests/tests_$(date +%Y%m%d_%H%M%S).app.zip --region ${{ secrets.AWS_RUM_GAMMA_REGION }} --metadata "commitHash=${{ github.sha }}"

    - name: Upload App to S3
      run: |
        # Upload app
        set -o pipefail && aws s3 cp ${{ github.workspace }}/Examples/PetClinic/PetClinic.ipa s3://${{ secrets.AWS_RUM_GAMMA_BUCKET_NAME }}/app/PetClinic_$(date +%Y%m%d_%H%M%S).ipa --region ${{ secrets.AWS_RUM_GAMMA_REGION }} --metadata "commitHash=${{ github.sha }}"
