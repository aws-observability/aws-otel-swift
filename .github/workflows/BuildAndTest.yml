# AWS OpenTelemetry Swift - Build and Test Pipeline
# Runs builds and tests on iOS, watchOS, and macOS
# (visionOS not supported by aws-sdk-swift)
# Triggered on: PR creation/updates, manual dispatch

name: Build and Test

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  macOS:
    name: macOS (with coverage)
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Build and Test
        run: |
          swift test --enable-code-coverage
          xcrun llvm-cov report .build/debug/aws-otel-swiftPackageTests.xctest/Contents/MacOS/aws-otel-swiftPackageTests -instr-profile .build/debug/codecov/default.profdata --format=text > coverage.txt
      - name: Check Repository Coverage
        run: |
          grep "^Sources/" coverage.txt
          # Filter only Sources directory files and calculate coverage
          sources_coverage=$(grep "^Sources/" coverage.txt | awk '{lines += $8; missed += $9} END {if (lines > 0) print ((lines - missed) / lines * 100); else print 0}')
          echo "Sources directory code coverage: ${sources_coverage}%"
          if (( $(echo "$sources_coverage < 70" | bc -l) )); then
            echo "❌ Sources coverage ${sources_coverage}% is below minimum threshold of 70%"
            exit 1
          else
            echo "✅ Sources coverage ${sources_coverage}% meets minimum threshold of 70%"
          fi
      - name: Check PR Coverage
        run: |
          # Get changed Swift files in Sources directory
          git fetch origin main
          changed_sources=$(git diff --name-only origin/main...HEAD | grep '^Sources/.*\.swift$' || true)

          if [ -n "$changed_sources" ]; then
            echo "Checking coverage for changed files:"
            echo "$changed_sources"
            echo "Coverage for changed files:"
            echo "$changed_sources" | while read file; do grep "^$file" coverage.txt || true; done
            
            # Calculate coverage for changed files only
            changed_coverage=$(echo "$changed_sources" | while read file; do grep "^$file" coverage.txt || true; done | awk '{lines += $8; missed += $9} END {if (lines > 0) print ((lines - missed) / lines * 100); else print 0}')
            echo "Changed files coverage: ${changed_coverage}%"
            
            if (( $(echo "$changed_coverage < 70" | bc -l) )); then
              echo "❌ Changed files coverage ${changed_coverage}% is below minimum threshold of 70%"
              exit 1
            else
              echo "✅ Changed files coverage ${changed_coverage}% meets minimum threshold of 70%"
            fi
          else
            echo "No Swift files changed in Sources directory"
          fi

  iOS:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v5
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Install Homebrew kegs
        run: make setup-brew
      - name: Build for iOS
        run: make build-for-testing-ios
      - name: Test for iOS
        run: make test-without-building-ios

  tvOS:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v5
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Install Homebrew kegs
        run: make setup-brew
      - name: Build for tvOS
        run: make build-for-testing-tvos
      - name: Test for tvOS
        run: make test-without-building-tvos

  watchOS:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v5
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Install Homebrew kegs
        run: make setup-brew
      - name: Build for watchOS
        run: make build-for-testing-watchos
      - name: Test for watchOS
        run: make test-without-building-watchos
# visionOS:
#   Temporarily disabled due to dependency compatibility issues with aws-sdk-swift
#   https://github.com/awslabs/aws-sdk-swift/blob/main/Package.swift#L493-L500
#
# visionOS:
#   runs-on: macos-15
#   steps:
#     - uses: actions/checkout@v5
#     - uses: maxim-lobanov/setup-xcode@v1
#       with:
#         xcode-version: latest-stable
#     - name: Install Homebrew kegs
#       run: make setup-brew
#     - name: Build for visionOS
#       run: make build-for-testing-visionos
#     - name: Test for visionOS
#       run: make test-without-building-visionos
